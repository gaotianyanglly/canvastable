<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bug ä¿®å¤éªŒè¯æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      background: #f5f5f5;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #333;
      border-bottom: 2px solid #1890ff;
      padding-bottom: 10px;
    }
    
    .controls {
      margin: 15px 0;
    }
    
    button {
      padding: 8px 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      background: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #40a9ff;
    }
    
    button.success {
      background: #52c41a;
    }
    
    button.danger {
      background: #ff4d4f;
    }
    
    .info {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    #table-container {
      border: 1px solid #ddd;
      margin-top: 10px;
    }
    
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .test-result.pass {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }
    
    .test-result.fail {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ Bug ä¿®å¤éªŒè¯æµ‹è¯•</h1>
  
  <!-- æµ‹è¯• 1: æ»šåŠ¨æ¡æ˜¾ç¤º -->
  <div class="test-section">
    <h2>æµ‹è¯• 1: æ»šåŠ¨æ¡æ˜¾ç¤ºé—®é¢˜</h2>
    <div class="info">
      <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯å¤§æ•°æ®é‡æ—¶æ»šåŠ¨æ¡æ˜¯å¦æ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œ
    </div>
    
    <div class="controls">
      <button onclick="testScrollbar(100)">åŠ è½½ 100 è¡Œ</button>
      <button onclick="testScrollbar(1000)">åŠ è½½ 1000 è¡Œ</button>
      <button onclick="testScrollbar(5000)">åŠ è½½ 5000 è¡Œ</button>
      <button onclick="checkScrollbar()">æ£€æŸ¥æ»šåŠ¨æ¡çŠ¶æ€</button>
    </div>
    
    <div id="scrollbar-result"></div>
    <div id="table-container-1" style="height: 400px;"></div>
  </div>
  
  <!-- æµ‹è¯• 2: æ ·å¼æ›´æ–° -->
  <div class="test-section">
    <h2>æµ‹è¯• 2: æ ·å¼æ›´æ–°é—®é¢˜</h2>
    <div class="info">
      <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯åŠ¨æ€ä¿®æ”¹æ ·å¼åæ˜¯å¦ç«‹å³ç”Ÿæ•ˆ
    </div>
    
    <div class="controls">
      <button onclick="testStyleChange('rowHeight', 60)">è®¾ç½®è¡Œé«˜ 60px</button>
      <button onclick="testStyleChange('rowHeight', 40)">æ¢å¤è¡Œé«˜ 40px</button>
      <button onclick="testStyleChange('fontSize', '18px')">è®¾ç½®å­—ä½“ 18px</button>
      <button onclick="testStyleChange('fontSize', '14px')">æ¢å¤å­—ä½“ 14px</button>
      <button onclick="testStyleChange('textColor', '#ff0000')">è®¾ç½®çº¢è‰²æ–‡å­—</button>
      <button onclick="testStyleChange('textColor', '#000000')">æ¢å¤é»‘è‰²æ–‡å­—</button>
      <button class="success" onclick="runAllStyleTests()">è¿è¡Œæ‰€æœ‰æ ·å¼æµ‹è¯•</button>
    </div>
    
    <div id="style-result"></div>
    <div id="table-container-2" style="height: 400px;"></div>
  </div>

  <script src="../umd/canvastable.min.js"></script>
  <script>
    let table1 = null;
    let table2 = null;
    
    // ç”Ÿæˆæµ‹è¯•æ•°æ®
    function generateData(count) {
      const data = [];
      for (let i = 0; i < count; i++) {
        data.push({
          id: i + 1,
          name: `ç”¨æˆ·${i + 1}`,
          age: 20 + Math.floor(Math.random() * 40),
          city: ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³'][Math.floor(Math.random() * 4)]
        });
      }
      return data;
    }
    
    const columns = [
      { title: 'ID', dataIndex: 'id', width: 80 },
      { title: 'å§“å', dataIndex: 'name', width: 120 },
      { title: 'å¹´é¾„', dataIndex: 'age', width: 80 },
      { title: 'åŸå¸‚', dataIndex: 'city', width: 120 }
    ];
    
    // æµ‹è¯• 1: æ»šåŠ¨æ¡
    function testScrollbar(rowCount) {
      const container = document.getElementById('table-container-1');
      
      if (table1) {
        table1.destroy();
        container.innerHTML = '';
      }
      
      table1 = new CanvasTable({
        container: container,
        columns: columns,
        dataSource: generateData(rowCount),
        style: {
          width: '100%',
          height: 400
        }
      });
      
      setTimeout(() => {
        checkScrollbar();
      }, 100);
    }
    
    function checkScrollbar() {
      if (!table1) {
        showResult('scrollbar-result', 'è¯·å…ˆåŠ è½½æ•°æ®', 'fail');
        return;
      }
      
      const scroller = table1.scroller;
      const hasScroller = !!scroller;
      const scrollerElement = scroller ? scroller.scrollRef.current : null;
      const hasScrollHeight = scrollerElement ? scrollerElement.scrollHeight > scrollerElement.clientHeight : false;
      
      console.log('æ»šåŠ¨æ¡æ£€æŸ¥:', {
        hasScroller,
        scrollerElement,
        scrollHeight: scrollerElement?.scrollHeight,
        clientHeight: scrollerElement?.clientHeight,
        hasScrollHeight,
        dataHeight: table1.dataHeight,
        height: table1.height
      });
      
      if (hasScroller && hasScrollHeight) {
        showResult('scrollbar-result', 
          `âœ… é€šè¿‡ï¼šæ»šåŠ¨æ¡æ­£å¸¸æ˜¾ç¤º (æ•°æ®é«˜åº¦: ${table1.dataHeight}px, å®¹å™¨é«˜åº¦: ${table1.height}px)`, 
          'pass');
      } else if (hasScroller && !hasScrollHeight) {
        showResult('scrollbar-result', 
          `âš ï¸ æ•°æ®é‡ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨æ¡ (æ•°æ®é«˜åº¦: ${table1.dataHeight}px, å®¹å™¨é«˜åº¦: ${table1.height}px)`, 
          'pass');
      } else {
        showResult('scrollbar-result', 'âŒ å¤±è´¥ï¼šæ»šåŠ¨æ¡æœªåˆ›å»º', 'fail');
      }
    }
    
    // æµ‹è¯• 2: æ ·å¼æ›´æ–°
    function initTable2() {
      const container = document.getElementById('table-container-2');
      
      if (table2) {
        table2.destroy();
        container.innerHTML = '';
      }
      
      table2 = new CanvasTable({
        container: container,
        columns: columns,
        dataSource: generateData(50),
        style: {
          width: '100%',
          height: 400
        }
      });
    }
    
    function testStyleChange(key, value) {
      if (!table2) {
        initTable2();
      }
      
      const oldValue = table2.styleManager.get(key);
      table2.updateStyle(key, value);
      
      setTimeout(() => {
        const newValue = table2.styleManager.get(key);
        const styleApplied = table2.style[key];
        
        console.log('æ ·å¼æ›´æ–°æµ‹è¯•:', {
          key,
          oldValue,
          newValue,
          styleApplied,
          expected: value
        });
        
        if (newValue === value && styleApplied === value) {
          showResult('style-result', 
            `âœ… é€šè¿‡ï¼š${key} å·²æ›´æ–°ä¸º ${value} (æ—§å€¼: ${oldValue})`, 
            'pass');
        } else {
          showResult('style-result', 
            `âŒ å¤±è´¥ï¼š${key} æ›´æ–°å¤±è´¥ (æœŸæœ›: ${value}, å®é™…: ${newValue}, style: ${styleApplied})`, 
            'fail');
        }
      }, 100);
    }
    
    function runAllStyleTests() {
      if (!table2) {
        initTable2();
      }
      
      const tests = [
        { key: 'rowHeight', value: 60 },
        { key: 'fontSize', value: '18px' },
        { key: 'textColor', value: '#ff0000' }
      ];
      
      let passCount = 0;
      let totalCount = tests.length;
      
      tests.forEach((test, index) => {
        setTimeout(() => {
          const oldValue = table2.styleManager.get(test.key);
          table2.updateStyle(test.key, test.value);
          
          setTimeout(() => {
            const newValue = table2.styleManager.get(test.key);
            const styleApplied = table2.style[test.key];
            
            if (newValue === test.value && styleApplied === test.value) {
              passCount++;
            }
            
            if (index === tests.length - 1) {
              if (passCount === totalCount) {
                showResult('style-result', 
                  `âœ… å…¨éƒ¨é€šè¿‡ï¼š${passCount}/${totalCount} ä¸ªæ ·å¼æµ‹è¯•é€šè¿‡`, 
                  'pass');
              } else {
                showResult('style-result', 
                  `âŒ éƒ¨åˆ†å¤±è´¥ï¼š${passCount}/${totalCount} ä¸ªæ ·å¼æµ‹è¯•é€šè¿‡`, 
                  'fail');
              }
            }
          }, 100);
        }, index * 300);
      });
    }
    
    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      testScrollbar(100);
      initTable2();
    });
  </script>
</body>
</html>

