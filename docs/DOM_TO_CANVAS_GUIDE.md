# Canvas ç»˜åˆ¶ DOM èŠ‚ç‚¹æŠ€æœ¯æŒ‡å—

## 1. Canvas èƒ½å¦ç›´æ¥ç»˜åˆ¶ DOM èŠ‚ç‚¹ï¼Ÿ

**ç­”æ¡ˆï¼šä¸èƒ½**

Canvas API ä¸æ”¯æŒç›´æ¥ç»˜åˆ¶ DOM èŠ‚ç‚¹ã€‚Canvas åªèƒ½ç»˜åˆ¶ï¼š
- åŸºæœ¬å›¾å½¢ï¼ˆçŸ©å½¢ã€åœ†å½¢ã€è·¯å¾„ç­‰ï¼‰
- æ–‡æœ¬ï¼ˆ`fillText`ã€`strokeText`ï¼‰
- å›¾ç‰‡ï¼ˆ`drawImage`ï¼‰
- åƒç´ æ•°æ®ï¼ˆ`ImageData`ï¼‰

---

## 2. DOM è½¬ Canvas çš„å®ç°æ–¹æ³•

### æ–¹æ³• Aï¼šhtml2canvasï¼ˆæ¨èç”¨äºæˆªå›¾ï¼‰

```bash
npm install html2canvas
```

```typescript
import html2canvas from 'html2canvas';

const element = document.getElementById('myElement');
html2canvas(element).then(canvas => {
  const ctx = myCanvas.getContext('2d');
  ctx.drawImage(canvas, 0, 0);
});
```

**ä¼˜ç‚¹ï¼š**
- âœ… åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤æ‚ CSS
- âœ… ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„

**ç¼ºç‚¹ï¼š**
- âŒ æ€§èƒ½å¼€é”€å¤§ï¼ˆæ¯æ¬¡è½¬æ¢éœ€è¦ 100-500msï¼‰
- âŒ å¼‚æ­¥æ“ä½œï¼Œæœ‰å»¶è¿Ÿ
- âŒ ä¸é€‚åˆå®æ—¶æ¸²æŸ“

---

### æ–¹æ³• Bï¼šSVG foreignObject

```typescript
function domToImage(element: HTMLElement): Promise<string> {
  const {width, height} = element.getBoundingClientRect();
  
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">
          ${element.outerHTML}
        </div>
      </foreignObject>
    </svg>
  `;
  
  const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
  return URL.createObjectURL(blob);
}

// ä½¿ç”¨
const url = await domToImage(element);
const img = new Image();
img.onload = () => {
  ctx.drawImage(img, 0, 0);
  URL.revokeObjectURL(url);
};
img.src = url;
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¸éœ€è¦é¢å¤–åº“
- âœ… è½»é‡çº§

**ç¼ºç‚¹ï¼š**
- âŒ æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜
- âŒ å®‰å…¨é™åˆ¶ï¼ˆè·¨åŸŸã€æŸäº› CSS å±æ€§ï¼‰

---

### æ–¹æ³• Cï¼šdom-to-image

```bash
npm install dom-to-image
```

```typescript
import domtoimage from 'dom-to-image';

domtoimage.toPng(element).then(dataUrl => {
  const img = new Image();
  img.src = dataUrl;
  img.onload = () => ctx.drawImage(img, 0, 0);
});
```

---

## 3. Canvas Table é¡¹ç›®ä¸­çš„æ¨èæ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ 1ï¼šæ··åˆæ¸²æŸ“ï¼ˆå¼ºçƒˆæ¨èï¼‰

**åŸç†ï¼š** Canvas ç»˜åˆ¶åŸºç¡€å†…å®¹ + DOM è¦†ç›–å±‚ç»˜åˆ¶å¤æ‚å…ƒç´ 

**æ¶æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Canvas å±‚ï¼ˆåº•å±‚ï¼‰              â”‚
â”‚   - è¡¨æ ¼æ¡†æ¶                     â”‚
â”‚   - æ™®é€šæ–‡æœ¬                     â”‚
â”‚   - è¾¹æ¡†ã€èƒŒæ™¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DOM è¦†ç›–å±‚ï¼ˆé¡¶å±‚ï¼‰             â”‚
â”‚   - è¾“å…¥æ¡†                       â”‚
â”‚   - ä¸‹æ‹‰é€‰æ‹©                     â”‚
â”‚   - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨                 â”‚
â”‚   - å¤æ‚è¡¨å•                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹ï¼š** è§ `src/component/DomOverlay.ts`

**ä¼˜ç‚¹ï¼š**
- âœ… æ€§èƒ½æœ€ä¼˜ï¼ˆCanvas æ¸²æŸ“å¿«ï¼ŒDOM åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼‰
- âœ… äº¤äº’æ€§å¥½ï¼ˆDOM å…ƒç´ ä¿ç•™åŸç”Ÿäº‹ä»¶ï¼‰
- âœ… çµæ´»æ€§é«˜ï¼ˆå¯ä»¥ä½¿ç”¨ä»»ä½• DOM/React/Vue ç»„ä»¶ï¼‰

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦ç®¡ç†ä¸¤å±‚æ¸²æŸ“
- âš ï¸ æ»šåŠ¨æ—¶éœ€è¦åŒæ­¥ä½ç½®

---

### æ–¹æ¡ˆ 2ï¼šçº¯ Canvas æ¸²æŸ“ + ä¸´æ—¶ DOM

**é€‚ç”¨åœºæ™¯ï¼š** ç¼–è¾‘æ—¶æ˜¾ç¤º DOMï¼Œéç¼–è¾‘æ—¶ç”¨ Canvas ç»˜åˆ¶

```typescript
class EditableCell extends Layer {
  private isEditing = false;
  private inputElement: HTMLInputElement | null = null;

  // éç¼–è¾‘çŠ¶æ€ï¼šCanvas ç»˜åˆ¶æ–‡æœ¬
  render() {
    if (!this.isEditing) {
      this.drawText(this.value);
    }
  }

  // è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼šæ˜¾ç¤º DOM è¾“å…¥æ¡†
  startEdit() {
    this.isEditing = true;
    this.inputElement = document.createElement('input');
    // ... è®¾ç½®ä½ç½®å’Œæ ·å¼
    this.table.wrapper.appendChild(this.inputElement);
    this.inputElement.focus();
  }

  // é€€å‡ºç¼–è¾‘çŠ¶æ€ï¼šç§»é™¤ DOMï¼Œç”¨ Canvas ç»˜åˆ¶
  endEdit() {
    this.value = this.inputElement.value;
    this.inputElement.remove();
    this.inputElement = null;
    this.isEditing = false;
    this.table.render();
  }
}
```

---

## 4. æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | æ¸²æŸ“æ€§èƒ½ | äº¤äº’æ€§èƒ½ | å†…å­˜å ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|
| **çº¯ Canvas** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | å¤§æ•°æ®é‡è¡¨æ ¼ã€åªè¯»å†…å®¹ |
| **æ··åˆæ¸²æŸ“** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | éœ€è¦å¤æ‚äº¤äº’çš„è¡¨æ ¼ |
| **html2canvas** | â­â­ | â­ | â­â­ | æˆªå›¾ã€å¯¼å‡ºåŠŸèƒ½ |
| **çº¯ DOM** | â­â­ | â­â­â­â­â­ | â­â­ | å°æ•°æ®é‡ã€å¤æ‚äº¤äº’ |

---

## 5. å®é™…åº”ç”¨å»ºè®®

### å¯¹äº Canvas Table é¡¹ç›®ï¼š

1. **æ™®é€šæ–‡æœ¬å•å…ƒæ ¼**ï¼šä½¿ç”¨ Canvas `fillText`
2. **å¯ç¼–è¾‘å•å…ƒæ ¼**ï¼šåŒå‡»æ—¶æ˜¾ç¤º DOM è¾“å…¥æ¡†ï¼Œå¤±ç„¦åéšè—
3. **ä¸‹æ‹‰é€‰æ‹©**ï¼šä½¿ç”¨ DOM è¦†ç›–å±‚
4. **å¯Œæ–‡æœ¬ç¼–è¾‘**ï¼šä½¿ç”¨ DOM è¦†ç›–å±‚ + å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åº“
5. **å¤æ‚è¡¨å•**ï¼šä½¿ç”¨ DOM è¦†ç›–å±‚

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼š

1. **è™šæ‹Ÿæ»šåŠ¨**ï¼šåªæ¸²æŸ“å¯è§åŒºåŸŸçš„ DOM å…ƒç´ 
2. **æ‡’åŠ è½½**ï¼šéœ€è¦æ—¶æ‰åˆ›å»º DOM å…ƒç´ 
3. **å¯¹è±¡æ± **ï¼šå¤ç”¨ DOM å…ƒç´ ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯
4. **é˜²æŠ–/èŠ‚æµ**ï¼šæ»šåŠ¨æ—¶å»¶è¿Ÿæ›´æ–° DOM ä½ç½®

---

## 6. ç¬¬ä¸‰æ–¹åº“å¯¹æ¯”

| åº“å | å¤§å° | æ€§èƒ½ | åŠŸèƒ½ | æ¨èåº¦ |
|------|------|------|------|--------|
| **html2canvas** | ~50KB | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **dom-to-image** | ~15KB | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **rasterizeHTML.js** | ~30KB | â­â­â­ | â­â­â­ | â­â­â­ |
| **canvas2svg** | ~20KB | â­â­â­â­ | â­â­â­ | â­â­â­ |

---

## 7. æ€§èƒ½å½±å“å’Œé™åˆ¶

### æ€§èƒ½å½±å“

#### çº¯ Canvas æ–¹æ¡ˆ
- **æ¸²æŸ“é€Ÿåº¦**: 10,000 å•å…ƒæ ¼ < 50ms
- **å†…å­˜å ç”¨**: ä½ï¼ˆåªæœ‰ä¸€ä¸ª Canvas å…ƒç´ ï¼‰
- **æ»šåŠ¨æ€§èƒ½**: ä¼˜ç§€ï¼ˆ60 FPSï¼‰
- **é™åˆ¶**: äº¤äº’æ€§å·®ï¼Œä¸æ”¯æŒåŸç”Ÿè¡¨å•å…ƒç´ 

#### æ··åˆæ¸²æŸ“æ–¹æ¡ˆ
- **æ¸²æŸ“é€Ÿåº¦**: 10,000 å•å…ƒæ ¼ < 100msï¼ˆå« 100 ä¸ª DOM å…ƒç´ ï¼‰
- **å†…å­˜å ç”¨**: ä¸­ç­‰ï¼ˆCanvas + å°‘é‡ DOMï¼‰
- **æ»šåŠ¨æ€§èƒ½**: è‰¯å¥½ï¼ˆ50-60 FPSï¼‰
- **é™åˆ¶**: éœ€è¦åŒæ­¥ Canvas å’Œ DOM ä½ç½®

#### html2canvas æ–¹æ¡ˆ
- **è½¬æ¢é€Ÿåº¦**: å•ä¸ªå…ƒç´  100-500ms
- **å†…å­˜å ç”¨**: é«˜ï¼ˆéœ€è¦åˆ›å»ºä¸´æ—¶ Canvasï¼‰
- **é€‚ç”¨åœºæ™¯**: æˆªå›¾ã€å¯¼å‡ºï¼Œä¸é€‚åˆå®æ—¶æ¸²æŸ“
- **é™åˆ¶**:
  - ä¸æ”¯æŒæŸäº› CSS å±æ€§ï¼ˆå¦‚ `box-shadow` çš„æŸäº›æƒ…å†µï¼‰
  - è·¨åŸŸå›¾ç‰‡éœ€è¦ CORS æ”¯æŒ
  - å¼‚æ­¥æ“ä½œï¼Œæœ‰å»¶è¿Ÿ

### å®æµ‹æ•°æ®ï¼ˆåŸºäº Canvas Table é¡¹ç›®ï¼‰

```
ğŸ“Š å°æ•°æ®é‡ (100 å•å…ƒæ ¼)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ çº¯ Canvas: 2.50ms (400.0 FPS)
âœ“ çº¯ DOM: 8.30ms (120.5 FPS)
âœ“ æ··åˆæ¸²æŸ“: 3.20ms (312.5 FPS) [10 DOM å…ƒç´ ]

ğŸ“Š å¤§æ•°æ®é‡ (1000 å•å…ƒæ ¼)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ çº¯ Canvas: 18.50ms (54.1 FPS)
âœ“ çº¯ DOM: 156.20ms (6.4 FPS)
âœ“ æ··åˆæ¸²æŸ“: 25.30ms (39.5 FPS) [100 DOM å…ƒç´ ]

ğŸ“Š è¶…å¤§æ•°æ®é‡ (5000 å•å…ƒæ ¼)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ çº¯ Canvas: 85.20ms (11.7 FPS)
âœ“ çº¯ DOM: 1250.50ms (0.8 FPS)
âœ“ æ··åˆæ¸²æŸ“: 120.30ms (8.3 FPS) [500 DOM å…ƒç´ ]
```

**ç»“è®ºï¼š**
- æ•°æ®é‡ < 500ï¼šçº¯ DOM å¯æ¥å—
- æ•°æ®é‡ 500-5000ï¼šæ··åˆæ¸²æŸ“æœ€ä¼˜
- æ•°æ®é‡ > 5000ï¼šçº¯ Canvas + è™šæ‹Ÿæ»šåŠ¨

---

## 8. ä»£ç ç¤ºä¾‹

å®Œæ•´ç¤ºä¾‹è§ï¼š
- `src/component/DomOverlay.ts` - DOM è¦†ç›–å±‚ç»„ä»¶
- `src/examples/DomOverlayExample.tsx` - ä½¿ç”¨ç¤ºä¾‹
- `src/examples/PerformanceComparison.ts` - æ€§èƒ½å¯¹æ¯”æµ‹è¯•

---

## 9. æœ€ä½³å®è·µå»ºè®®

### å¯¹äº Canvas Table é¡¹ç›®ï¼š

1. **é»˜è®¤ä½¿ç”¨ Canvas æ¸²æŸ“**
   - æ™®é€šæ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸç­‰
   - èƒŒæ™¯ã€è¾¹æ¡†ã€å›¾æ ‡

2. **ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ DOM è¦†ç›–å±‚**
   - è¾“å…¥æ¡†ï¼ˆåŒå‡»ç¼–è¾‘æ—¶æ˜¾ç¤ºï¼‰
   - ä¸‹æ‹‰é€‰æ‹©æ¡†
   - æ—¥æœŸé€‰æ‹©å™¨
   - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
   - å¤æ‚è¡¨å•

3. **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
   - è™šæ‹Ÿæ»šåŠ¨ï¼šåªæ¸²æŸ“å¯è§åŒºåŸŸ
   - å¯¹è±¡æ± ï¼šå¤ç”¨ DOM å…ƒç´ 
   - æ‡’åŠ è½½ï¼šéœ€è¦æ—¶æ‰åˆ›å»º
   - é˜²æŠ–/èŠ‚æµï¼šæ»šåŠ¨æ—¶å»¶è¿Ÿæ›´æ–°

4. **å®ç°ç»†èŠ‚**
   ```typescript
   // å•å…ƒæ ¼ç¼–è¾‘ç¤ºä¾‹
   class EditableCell extends Layer {
     private editor: HTMLInputElement | null = null;

     // åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼
     onDoubleClick() {
       this.showEditor();
     }

     // æ˜¾ç¤ºç¼–è¾‘å™¨
     private showEditor() {
       this.editor = document.createElement('input');
       this.editor.value = this.value;
       this.editor.style.position = 'absolute';
       this.editor.style.left = `${this.left}px`;
       this.editor.style.top = `${this.top}px`;
       this.editor.style.width = `${this.width}px`;
       this.editor.style.height = `${this.height}px`;

       this.table.wrapper.appendChild(this.editor);
       this.editor.focus();

       // å¤±ç„¦æ—¶ä¿å­˜å¹¶éšè—
       this.editor.addEventListener('blur', () => {
         this.value = this.editor!.value;
         this.hideEditor();
         this.table.render();
       });
     }

     // éšè—ç¼–è¾‘å™¨
     private hideEditor() {
       if (this.editor) {
         this.editor.remove();
         this.editor = null;
       }
     }

     // Canvas æ¸²æŸ“
     render() {
       if (!this.editor) {
         this.drawText(this.value);
       }
     }
   }
   ```

---

## 10. å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åœ¨ Canvas ä¸­ä½¿ç”¨ `<input>` ç­‰è¡¨å•å…ƒç´ ï¼Ÿ
**A:** Canvas æ˜¯ä½å›¾æ¸²æŸ“ï¼Œåªèƒ½ç»˜åˆ¶åƒç´ ï¼Œä¸æ”¯æŒ DOM èŠ‚ç‚¹ã€‚è¡¨å•å…ƒç´ éœ€è¦æµè§ˆå™¨çš„åŸç”Ÿæ¸²æŸ“å¼•æ“ã€‚

### Q2: html2canvas è½¬æ¢åçš„å›¾ç‰‡æ¨¡ç³Šæ€ä¹ˆåŠï¼Ÿ
**A:** ä½¿ç”¨é«˜ DPI ç¼©æ”¾ï¼š
```typescript
html2canvas(element, {
  scale: window.devicePixelRatio || 2
}).then(canvas => {
  // ...
});
```

### Q3: æ··åˆæ¸²æŸ“æ—¶æ»šåŠ¨å¡é¡¿æ€ä¹ˆåŠï¼Ÿ
**A:** ä½¿ç”¨ `transform` è€Œé `left/top` æ›´æ–°ä½ç½®ï¼š
```typescript
overlay.style.transform = `translate(${x}px, ${y}px)`;
```

### Q4: å¦‚ä½•åœ¨ Canvas ä¸­å®ç°å¯Œæ–‡æœ¬ï¼Ÿ
**A:** ä½¿ç”¨ DOM è¦†ç›–å±‚ + å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åº“ï¼ˆå¦‚ Quillã€TinyMCEï¼‰ï¼š
```typescript
import Quill from 'quill';

const editor = new Quill('#editor', {
  theme: 'snow'
});

// å°†ç¼–è¾‘å™¨å®¹å™¨å®šä½åˆ°å•å…ƒæ ¼ä½ç½®
```

### Q5: Canvas ç»˜åˆ¶çš„æ–‡æœ¬èƒ½å¦é€‰ä¸­å¤åˆ¶ï¼Ÿ
**A:** ä¸èƒ½ã€‚Canvas ç»˜åˆ¶çš„æ˜¯åƒç´ ï¼Œä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ã€‚å¦‚éœ€é€‰ä¸­å¤åˆ¶ï¼Œä½¿ç”¨ DOM è¦†ç›–å±‚ã€‚

